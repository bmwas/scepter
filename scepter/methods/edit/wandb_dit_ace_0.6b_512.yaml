ENV:
  BACKEND: nccl
  SEED: 2024
#
SOLVER:
  NAME: ACESolver
  RESUME_FROM:
  LOAD_MODEL_ONLY: True
  USE_FSDP: False
  SHARDING_STRATEGY:
  USE_AMP: True
  DTYPE: float16
  CHANNELS_LAST: True
  MAX_STEPS: 500
  MAX_EPOCHS: 3
  NUM_FOLDS: 10
  ACCU_STEP: 1
  EVAL_INTERVAL: 2
  RESCALE_LR: False
  #
  WORK_DIR: ./cache/save_data/ace_0.6b_512
  LOG_FILE: std_log.txt
  #
  FILE_SYSTEM:
    - NAME: "HuggingfaceFs"
      TEMP_DIR: ./cache/cache_data
    - NAME: "LocalFs"
      TEMP_DIR: ./cache/cache_data
    - NAME: "ModelscopeFs"
      TEMP_DIR: ./cache/cache_data

  #
  MODEL:
    NAME: LatentDiffusionACE
    PRETRAINED_MODEL:
    IGNORE_KEYS: [ ]
    SCALE_FACTOR: 0.18215
    SIZE_FACTOR: 8
    DECODER_BIAS: 0.5
    DEFAULT_N_PROMPT:
    USE_EMA: True
    EMA_DECAY: 0.9999
    EVAL_EMA: True
    TEXT_IDENTIFIER: [ '{image}', '{image1}', '{image2}', '{image3}', '{image4}', '{image5}', '{image6}', '{image7}', '{image8}', '{image9}' ]
    USE_TEXT_POS_EMBEDDINGS: True
    #
    DIFFUSION:
      NAME: BaseDiffusion
      PREDICTION_TYPE: eps
      MIN_SNR_GAMMA: 5.0  # Add SNR clamping for better stability
      NOISE_SCHEDULER:
        NAME: LinearScheduler
        NUM_TIMESTEPS: 1000
        BETA_MIN: 0.0001
        BETA_MAX: 0.02
    #
    DIFFUSION_MODEL:
      NAME: ACE
      PRETRAINED_MODEL: ms://iic/ACE-0.6B-512px@models/dit/ace_0.6b_512px.pth
      IGNORE_KEYS: [ ]
      PATCH_SIZE: 2
      IN_CHANNELS: 4
      HIDDEN_SIZE: 1152
      DEPTH: 28
      NUM_HEADS: 16
      MLP_RATIO: 4.0
      PRED_SIGMA: True
      DROP_PATH: 0.0
      WINDOW_DIZE: 0
      Y_CHANNELS: 4096
      MAX_SEQ_LEN: 1024
      QK_NORM: True
      USE_GRAD_CHECKPOINT: True
      ATTENTION_BACKEND: flash_attn
    #
    FIRST_STAGE_MODEL:
      NAME: AutoencoderKL
      EMBED_DIM: 4
      PRETRAINED_MODEL: ms://iic/ACE-0.6B-512px@models/vae/vae.bin
      IGNORE_KEYS: []
      #
      ENCODER:
        NAME: Encoder
        CH: 128
        OUT_CH: 3
        NUM_RES_BLOCKS: 2
        IN_CHANNELS: 3
        ATTN_RESOLUTIONS: [ ]
        CH_MULT: [ 1, 2, 4, 4 ]
        Z_CHANNELS: 4
        DOUBLE_Z: True
        DROPOUT: 0.0
        RESAMP_WITH_CONV: True
      #
      DECODER:
        NAME: Decoder
        CH: 128
        OUT_CH: 3
        NUM_RES_BLOCKS: 2
        IN_CHANNELS: 3
        ATTN_RESOLUTIONS: [ ]
        CH_MULT: [ 1, 2, 4, 4 ]
        Z_CHANNELS: 4
        DROPOUT: 0.0
        RESAMP_WITH_CONV: True
        GIVE_PRE_END: False
        TANH_OUT: False
    #
    COND_STAGE_MODEL:
      NAME: T5EmbedderHF
      PRETRAINED_MODEL: ms://iic/ACE-0.6B-512px@models/text_encoder/t5-v1_1-xxl/
      TOKENIZER_PATH: ms://iic/ACE-0.6B-512px@models/tokenizer/t5-v1_1-xxl
      LENGTH: 120
      T5_DTYPE: bfloat16
      ADDED_IDENTIFIER: [ '{image}', '{caption}', '{mask}', '{ref_image}', '{image1}', '{image2}', '{image3}', '{image4}', '{image5}', '{image6}', '{image7}', '{image8}', '{image9}' ]
      CLEAN: whitespace
      USE_GRAD: False
    LOSS:
      NAME: ReconstructLoss
      LOSS_TYPE: l2
      LOSS_WEIGHT: 1.0
      LOSS_CLIP: 10.0
  #
  SAMPLE_ARGS:
    SAMPLER: ddim
    SAMPLE_STEPS: 20
    GUIDE_SCALE: 4.5
    GUIDE_RESCALE: 0.5
  #
  OPTIMIZER:
    NAME: AdamW
    LEARNING_RATE: 5e-8
    EPS: 1e-8
    WEIGHT_DECAY: 1e-4
    CLIP_GRAD_NORM: 0.5
    BETAS: [0.9, 0.999]
  #
  LR_SCHEDULER:
    NAME: CosineAnnealingLR
    T_MAX: 500
    ETA_MIN: 0
    WARMUP_STEPS: 100
  #
  TRAIN_DATA:
    NAME: CSVInRAMDataset
    CSV_PATH: ./cache/datasets/therapy_pair/images_therapist/training.csv
    MODE: train
    PROMPT_PREFIX: ""
    MAX_SEQ_LEN: 1024
    PIN_MEMORY: True
    BATCH_SIZE: 4
    NUM_WORKERS: 1
    IMAGE_ROOT_DIR: "./cache/datasets/therapy_pair/"
    NEGATIVE_PROMPT: ""
    SAMPLER:
      NAME: LoopSampler
    COLLATE_FN: CSVInRAMDataset.collate_fn
  #
  VAL_DATA:
    NAME: CSVInRAMDataset
    CSV_PATH: ./cache/datasets/therapy_pair/images_therapist/validation.csv
    MODE: validation
    PROMPT_PREFIX: ""
    MAX_SEQ_LEN: 1024
    PIN_MEMORY: True
    BATCH_SIZE: 4
    NUM_WORKERS: 1
    IMAGE_ROOT_DIR: "./cache/datasets/therapy_pair/"
    NEGATIVE_PROMPT: ""
    COLLATE_FN: CSVInRAMDataset.collate_fn
  #
  TRAIN_HOOKS:
    # ---------------- core training ----------------
    - {NAME: BackwardHook,   PRIORITY: 0}
    - {NAME: LogHook,        LOG_INTERVAL: 50, PRIORITY: 100}

    # ---------------- wandb initialiser ----------------
    - {NAME: WandbLogHook,   PRIORITY: 100,                # must come before every other wandb‑hook
      PROJECT_NAME: "scepter-project",                     # Match the default project name in BaseSolver
      RUN_NAME: "ace_0.6b_512_final",
      TAGS: [ACE, 0.6B],
      SAVE_CODE: True}

    # ---------------- wandb loss tracking ----------------
    - {NAME: WandbLogHook,   PRIORITY: 101,                # must come before every other wandb‑hook
      PROJECT_NAME: "scepter-project",                     # Match the default project name in BaseSolver
      RUN_NAME: "ace_0.6b_512_final",
      TAGS: [ACE, 0.6B],
      SAVE_CODE: True,
      LOG_INTERVAL: 1}
    # ---------------- checkpoints & metrics ----------------
    - {NAME: CheckpointHook,      INTERVAL: 100,  PRIORITY: 300,
      PUSH_TO_HUB: true,
      HUB_MODEL_ID: "benvisio/ace-model-0.6b-512",  # Change to your desired repo name
      HUB_PRIVATE: false,
      HUB_TOKEN: "${env:MODELSCOPE_TOKEN}"}
    - {NAME: WandbCheckpointHook, CHECKPOINT_INTERVAL: 100, SAVE_BEST: True,
      SAVE_BEST_BY: "+loss",     PRIORITY: 300}            # :contentReference[oaicite:0]{index=0}

    # ---------------- LR tracking ------------ 
    - {NAME: WandbLrHook,         LOG_LR_SCHEDULE: True, PRIORITY: 200}     # :contentReference[oaicite:1]{index=1}
    # Note: WandbValLossHook removed as it requires run_step_val method

    # ---------------- images / probe data -----------------
    - {NAME: ProbeDataHook,       PROB_INTERVAL: 100}                        # keeps local saves
    - {NAME: WandbProbeDataHook,  PROB_INTERVAL: 100, LOG_IMAGES: True,
      LOG_VIDEOS: True, PRIORITY: 1000}                                     # :contentReference[oaicite:3]{index=3}

    # ---------------- file/artifact sweeper ---------------
    - {NAME: WandbFileTrackerHook, TRACK_INTERVAL: 30, PRIORITY: 1100}       # :contentReference[oaicite:4]{index=4}

    # ParameterTrackerHook removed due to error: missing required 'param' argument

    # WandbValLossHook requires DATA or VAL_DATA which is missing
    # - {NAME: WandbValLossHook, PRIORITY: 250}
    # - {NAME: WandbValLossHook, PRIORITY: 250}
